name: Build

on:
  workflow_dispatch:
    inputs:
      board:
        description: "Target board"
        required: false
        default: "tang_nano_9k"
      firmware:
        description: "Firmware image"
        required: false
        default: "bios"

permissions:
  contents: read
  actions: read

env:
  GOWIN_VERSION: "1.9.11.03"
  GOWIN_DIR: IDE
  BUILD_OUTPUT_DIR: build
  IMAGE_NAME: riscv-soc

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Docker availability
        run: |
          docker --version
          docker info

      - name: Cache GOWIN IDE
        id: cache-gowin
        uses: actions/cache@v4
        with:
          path: ${{ env.GOWIN_DIR }}
          key: gowin-ide-${{ env.GOWIN_VERSION }}

      - name: Download and install GOWIN IDE
        if: steps.cache-gowin.outputs.cache-hit != 'true'
        run: |
          echo "Downloading GOWIN EDA Education $GOWIN_VERSION..."
          GOWIN_TAR="Gowin_V${GOWIN_VERSION}_Education_Linux.tar.gz"
          curl -L "https://cdn.gowinsemi.com.cn/$GOWIN_TAR" -o "$GOWIN_TAR"
          mkdir -p "$GOWIN_DIR"
          tar -xzf "$GOWIN_TAR"
          rm "$GOWIN_TAR"

      #- name: Set up Docker Buildx
      #  uses: docker/setup-buildx-action@v3

      #- name: Build Docker image
      #  uses: docker/build-push-action@v6
      #  with:
      #    context: .
      #    file: ./Dockerfile
      #    tags: ${{ env.IMAGE_NAME }}:latest
      #    push: false
      #    load: true
      #    cache-from: type=gha
      #    cache-to: type=gha,mode=max

      - name: Build
        env:
          BOARD: ${{ github.event.inputs.board }}
          FIRMWARE: ${{ github.event.inputs.firmware }}
        run: |
          mkdir -p "$BUILD_OUTPUT_DIR"
          make build DOCKER_IMAGE=${{ env.IMAGE_NAME }}:latest BOARD=$BOARD FIRMWARE=$FIRMWARE

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: fpga-build-${{ github.run_number }}
          path: ${{ env.BUILD_OUTPUT_DIR }}
