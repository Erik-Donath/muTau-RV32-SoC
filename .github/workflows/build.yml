name: Build

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

env:
  GOWIN_VERSION: "1.9.11.03"
  GOWIN_DIR: IDE
  BUILD_OUTPUT_DIR: build
  IMAGE_NAME: riscv

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Docker availability
        run: |
          docker --version
          docker info

      - name: Cache GOWIN IDE
        id: cache-gowin
        uses: actions/cache@v4
        with:
          path: ${{ env.GOWIN_DIR }}
          key: gowin-ide-${{ env.GOWIN_VERSION }}

      - name: Download and install GOWIN IDE
        if: steps.cache-gowin.outputs.cache-hit != 'true'
        run: |
          echo "Downloading GOWIN EDA Education $GOWIN_VERSION..."
          GOWIN_TAR="Gowin_V${GOWIN_VERSION}_Education_Linux.tar.gz"
          curl -L "https://cdn.gowinsemi.com.cn/$GOWIN_TAR" -o "$GOWIN_TAR"
          mkdir -p "$GOWIN_DIR"
          tar -xzf "$GOWIN_TAR"
          rm "$GOWIN_TAR"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          tags: ${{ env.IMAGE_NAME }}:latest
          push: false
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run build inside container
        run: |
          mkdir -p "$BUILD_OUTPUT_DIR"
          docker run --rm \
            -v "$PWD":/workspace \
            -w /workspace \
            -e PYTHON=/opt/venv/bin/python3 \
            -e GOWIN_HOME=/workspace/IDE \
            ${{ env.IMAGE_NAME }}:latest \
            bash -lc '/opt/venv/bin/python3 cpu.py --build'

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: fpga-build-${{ github.run_number }}
          path: ${{ env.BUILD_OUTPUT_DIR }}
